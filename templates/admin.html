{% extends "base.html" %}

{% block title %}Admin Dashboard - Secure File Manager{% endblock %}

{% block navbar %}
<li class="nav-item">
    <a class="nav-link" href="/dashboard">My Files</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/admin">Admin</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" onclick="logout()">Logout</a>
</li>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>
            <p class="text-muted">Security monitoring and system overview</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Total Users</h6>
                            <h3 class="mb-0" id="totalUsers">-</h3>
                        </div>
                        <i class="bi bi-people fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Total Files</h6>
                            <h3 class="mb-0" id="totalFiles">-</h3>
                        </div>
                        <i class="bi bi-files fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Total Logs</h6>
                            <h3 class="mb-0" id="totalLogs">-</h3>
                        </div>
                        <i class="bi bi-journal-text fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase mb-1">Recent Alerts</h6>
                            <h3 class="mb-0" id="recentAlerts">-</h3>
                        </div>
                        <i class="bi bi-exclamation-triangle fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Statistics -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Login Statistics (Last 7 Days)</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="totalLogins" class="text-primary">-</h4>
                            <p class="text-muted mb-0">Total</p>
                        </div>
                        <div class="col-4">
                            <h4 id="successfulLogins" class="text-success">-</h4>
                            <p class="text-muted mb-0">Successful</p>
                        </div>
                        <div class="col-4">
                            <h4 id="failedLogins" class="text-danger">-</h4>
                            <p class="text-muted mb-0">Failed</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress" style="height: 25px;">
                            <div id="successBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
                            <div id="failedBar" class="progress-bar bg-danger" role="progressbar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-hdd"></i> Storage Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 id="totalFilesStorage" class="text-primary">-</h4>
                            <p class="text-muted mb-0">Files</p>
                        </div>
                        <div class="col-6">
                            <h4 id="totalSize" class="text-info">-</h4>
                            <p class="text-muted mb-0">Total Size</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Alerts Table -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Recent Security Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Severity</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>User ID</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Loading alerts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Audit Logs -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-text"></i> Audit Logs</h5>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="severityFilter" onchange="loadLogs()">
                            <option value="">All Severities</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Timestamp</th>
                                    <th>Severity</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>User ID</th>
                                    <th>IP</th>
                                    <th>Success</th>
                                </tr>
                            </thead>
                            <tbody id="logsTable">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Loading logs...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-people"></i> All Users</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>2FA</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-hourglass-split"></i> Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const token = getToken();
    const user = getUser();
    
    if (!token || !user || user.role !== 'ADMIN') {
        window.location.href = '/dashboard';
    }

    // Load all data on page load
    loadDashboard();
    loadLogs();
    loadUsers();

    async function loadDashboard() {
        try {
            const response = await fetch('/api/admin/dashboard', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to load dashboard');
            
            const data = await response.json();
            
            // Update statistics
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('totalFiles').textContent = data.total_files;
            document.getElementById('totalLogs').textContent = data.total_logs;
            document.getElementById('recentAlerts').textContent = data.recent_alerts.length;
            
            // Update login stats
            document.getElementById('totalLogins').textContent = data.login_stats.total;
            document.getElementById('successfulLogins').textContent = data.login_stats.successful;
            document.getElementById('failedLogins').textContent = data.login_stats.failed;
            
            // Update progress bar
            const successPercent = data.login_stats.total > 0 
                ? (data.login_stats.successful / data.login_stats.total * 100).toFixed(1)
                : 0;
            const failedPercent = data.login_stats.total > 0 
                ? (data.login_stats.failed / data.login_stats.total * 100).toFixed(1)
                : 0;
            
            document.getElementById('successBar').style.width = successPercent + '%';
            document.getElementById('successBar').textContent = successPercent + '%';
            document.getElementById('failedBar').style.width = failedPercent + '%';
            document.getElementById('failedBar').textContent = failedPercent + '%';
            
            // Update file stats
            document.getElementById('totalFilesStorage').textContent = data.file_stats.total;
            document.getElementById('totalSize').textContent = formatFileSize(data.file_stats.total_size);
            
            // Display alerts
            displayAlerts(data.recent_alerts);
            
        } catch (error) {
            showAlert('Failed to load dashboard', 'danger');
            console.error(error);
        }
    }

    function displayAlerts(alerts) {
        const tbody = document.getElementById('alertsTable');
        
        if (alerts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-success">
                        <i class="bi bi-check-circle"></i> No recent security alerts
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = alerts.map(alert => `
            <tr>
                <td>${new Date(alert.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-${getSeverityColor(alert.severity)}">${alert.severity}</span></td>
                <td>${alert.action}</td>
                <td>${alert.details || '-'}</td>
                <td>${alert.user_id || '-'}</td>
                <td>${alert.ip_address || '-'}</td>
            </tr>
        `).join('');
    }

    async function loadLogs() {
        const severity = document.getElementById('severityFilter').value;
        const url = severity ? `/api/admin/logs?severity=${severity}&limit=200` : '/api/admin/logs?limit=200';
        
        try {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to load logs');
            
            const logs = await response.json();
            displayLogs(logs);
            
        } catch (error) {
            showAlert('Failed to load logs', 'danger');
            console.error(error);
        }
    }

    function displayLogs(logs) {
        const tbody = document.getElementById('logsTable');
        
        if (logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        <i class="bi bi-inbox"></i> No logs found
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = logs.map(log => `
            <tr class="${!log.success ? 'table-warning' : ''}">
                <td>${log.id}</td>
                <td>${new Date(log.timestamp).toLocaleString()}</td>
                <td><span class="badge bg-${getSeverityColor(log.severity)}">${log.severity}</span></td>
                <td>${log.action}</td>
                <td>${log.details || '-'}</td>
                <td>${log.user_id || '-'}</td>
                <td>${log.ip_address || '-'}</td>
                <td>${log.success ? '✓' : '✗'}</td>
            </tr>
        `).join('');
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Failed to load users');
            
            const users = await response.json();
            displayUsers(users);
            
        } catch (error) {
            showAlert('Failed to load users', 'danger');
            console.error(error);
        }
    }

    function displayUsers(users) {
        const tbody = document.getElementById('usersTable');
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td><span class="badge bg-${user.role === 'ADMIN' ? 'danger' : 'primary'}">${user.role}</span></td>
                <td>${user.two_factor_enabled ? '✓' : '✗'}</td>
                <td>${new Date(user.created_at).toLocaleString()}</td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
            </tr>
        `).join('');
    }

    function getSeverityColor(severity) {
        switch(severity) {
            case 'INFO': return 'info';
            case 'WARNING': return 'warning';
            case 'CRITICAL': return 'danger';
            default: return 'secondary';
        }
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadDashboard();
        loadLogs();
    }, 30000);
</script>
{% endblock %}
